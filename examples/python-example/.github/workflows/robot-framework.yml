name: "Example â€” Robot Framework (Python)"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Copy this file to your project's .github/workflows/ directory.
# Requires: requirements.txt with robotframework, robotframework-seleniumlibrary
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      suite:
        description: "Test suite tag"
        default: "regression"
        type: string
      python-version:
        description: "Python version"
        default: "3.11"
        type: choice
        options: ["3.10", "3.11", "3.12"]

env:
  PYTHON_VERSION: ${{ inputs.python-version || '3.11' }}

jobs:
  # â”€â”€ LAYER 1: Setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  setup:
    name: "âš™ï¸ Setup â€” Python ${{ env.PYTHON_VERSION }}"
    runs-on: ubuntu-latest
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Compute cache key
        id: cache-key
        run: |
          HASH="${{ hashFiles('requirements.txt') }}"
          echo "key=pip-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-${HASH}" \
            >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Install Chrome
        run: |
          sudo apt-get update -q
          sudo apt-get install -y google-chrome-stable

  # â”€â”€ LAYER 2: Test â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  test:
    name: "ðŸ¤– Tests â€” Robot Framework"
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Install Chrome
        run: |
          sudo apt-get update -q
          sudo apt-get install -y google-chrome-stable chromedriver

      - name: Run Robot Framework
        run: |
          robot \
            --include ${{ inputs.suite || 'regression' }} \
            --variable BROWSER:chrome \
            --variable BASE_URL:${{ secrets.BASE_URL }} \
            --outputdir results/ \
            --xunit junit-results.xml \
            tests/
        continue-on-error: true  # collect artifacts even on failure

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: robot-results
          path: |
            results/output.xml
            results/log.html
            results/report.html
            results/junit-results.xml
          retention-days: 7

  # â”€â”€ LAYER 3: Report â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  report:
    name: "ðŸ“Š Report â€” Parse Robot output"
    runs-on: ubuntu-latest
    needs: test
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: Download results
        uses: actions/download-artifact@v4
        with:
          name: robot-results
          path: results/

      - name: Parse output.xml â†’ qa-metrics/metrics.json
        run: |
          python3 << 'PYEOF'
          import xml.etree.ElementTree as ET, json, os

          try:
              tree = ET.parse('results/output.xml')
              root = tree.getroot()
              # output.xml: statistics/total/stat[@name="All Tests"]
              xpath = './/statistics/total/stat[@name="All Tests"]'
              stat = root.find(xpath)
              passed  = int(stat.get('pass', 0))
              failed  = int(stat.get('fail', 0))
              skipped = int(stat.get('skip', 0))
              total   = passed + failed + skipped
              rate    = round(passed / total * 100, 2) if total > 0 else 0.0
          except Exception as e:
              print(f"Warning: could not parse output.xml: {e}")
              total = passed = failed = skipped = 0
              rate = 0.0

          os.makedirs('qa-metrics', exist_ok=True)
          json.dump({
              'tool': 'robot-framework', 'total': total,
              'passed': passed, 'failed': failed,
              'skipped': skipped, 'flaky_count': 0, 'pass_rate': rate
          }, open('qa-metrics/metrics.json', 'w'), indent=2)
          print(f"Total={total}|Passed={passed}|Failed={failed}|Rate={rate}%")
          PYEOF

      - name: Upload qa-metrics
        uses: actions/upload-artifact@v4
        with:
          name: qa-metrics
          path: qa-metrics/metrics.json

  # â”€â”€ LAYER 4: Quality Gate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  quality-gate:
    name: "ðŸš¦ Quality Gate"
    needs: report
    uses: your-org/qa-ci-pipelines/.github/workflows/shared/quality-gate.yml@main
    with:
      min-pass-rate: "95"
      max-flaky-count: "0"
      block-on-failure: true
