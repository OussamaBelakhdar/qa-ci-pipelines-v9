name: "Example â€” Mono-repo / Multi-tool Matrix"

# This example demonstrates running multiple QA tools in parallel
# across a mono-repo with multiple sub-projects.

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # LAYER 1 â€” Parallel unit smoke
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  api-smoke:
    name: "API Smoke â€” Newman"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
      - run: npm install -g newman newman-reporter-htmlextra
      - run: |
          newman run api-tests/smoke.postman_collection.json \
            --environment api-tests/staging.postman_environment.json \
            --reporters cli,htmlextra \
            --reporter-htmlextra-export reports/api-smoke.html
        env:
          API_KEY: ${{ secrets.API_KEY }}
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: api-smoke-report
          path: reports/api-smoke.html

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # LAYER 2 â€” UI multi-browser matrix
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ui-tests:
    name: "UI â€” Playwright / ${{ matrix.browser }}"
    runs-on: ubuntu-latest
    needs: api-smoke
    fail-fast: false
    strategy:
      matrix:
        browser: [chromium, firefox, webkit]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
      - run: npm ci
      - name: Cache Playwright
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: pw-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
      - run: npx playwright install --with-deps ${{ matrix.browser }}
      - run: npx playwright test --project=${{ matrix.browser }}
        env:
          BASE_URL: ${{ secrets.BASE_URL }}
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-${{ matrix.browser }}
          path: playwright-report/
          retention-days: 7

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # LAYER 3 â€” Performance gate
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  performance-gate:
    name: "Performance â€” k6 Smoke"
    runs-on: ubuntu-latest
    needs: ui-tests
    steps:
      - uses: actions/checkout@v4
      - name: Install k6
        run: |
          K6_URL=https://github.com/grafana/k6/releases/download
          K6_PKG=k6-v0.49.0-linux-amd64.tar.gz
          curl -L "${K6_URL}/v0.49.0/${K6_PKG}" | tar xvz
          sudo mv k6-v0.49.0-linux-amd64/k6 /usr/local/bin
      - name: Run k6 smoke test
        run: |
          k6 run \
            --vus 5 \
            --duration 30s \
            --summary-export=reports/k6-summary.json \
            performance/smoke.js
        env:
          BASE_URL: ${{ secrets.BASE_URL }}
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: k6-smoke-report
          path: reports/k6-summary.json

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # FINAL â€” Aggregated summary
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  summary:
    name: "Pipeline Summary"
    runs-on: ubuntu-latest
    needs: [api-smoke, ui-tests, performance-gate]
    if: always()
    steps:
      - name: Pipeline summary
        run: |
          echo "## ðŸš€ Mono-repo QA Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Layer | Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-----|--------|" >> $GITHUB_STEP_SUMMARY
          R1="${{ needs.api-smoke.result }}"
          R2="${{ needs.ui-tests.result }}"
          R3="${{ needs.performance-gate.result }}"
          {
            echo "| Layer 1 | API Smoke (Newman) | ${R1} |"
            echo "| Layer 2 | UI Multi-browser (Playwright) | ${R2} |"
            echo "| Layer 3 | Performance Gate (k6) | ${R3} |"
          } >> $GITHUB_STEP_SUMMARY
